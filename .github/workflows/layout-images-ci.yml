name: Layout Images CI/CD
# This workflow automatically converts VIAL layouts to visualizations
on:
  push:
    branches: [main]
    paths:
      - "firmware/*.vil"
      - "keymap-drawer.yaml"
      - ".github/workflows/layout-images-ci.yml"
  pull_request:
    branches: [main]
    paths:
      - "firmware/*.vil"
      - "keymap-drawer.yaml"
      - ".github/workflows/layout-images-ci.yml"
  workflow_dispatch:
permissions:
  contents: write
  pull-requests: write
env:
  CI: "true" # Exclude dev-only packages from nix shell (saves ~5-8GB disk space)
  NIX_CONFIG: |
    experimental-features = nix-command flakes pipe-operators
    allow-import-from-derivation = true
    accept-flake-config = true
    extra-substituters = https://cache.nixos.org https://nix-community.cachix.org
    extra-trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=
jobs:
  generate-images:
    name: Generate Layout Images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install Nix
        uses: cachix/install-nix-action@v26
        with:
          extra_nix_config: ${{ env.NIX_CONFIG }}
      - name: Auto-convert .vil files to JSON and YAML
        run: |
          echo "=== Auto-converting VIAL layouts ==="

          nix develop --command bash <<'SCRIPT'
            set -e  # Exit immediately if a command fails
            echo 'üîÑ Converting .vil ‚Üí .json ‚Üí .yaml...'

            # Track conversion status
            success_count=0
            failure_count=0
            failed_files=""

            for vil_file in firmware/*.vil; do
              if [ -f "$vil_file" ]; then
                base_name=$(basename "$vil_file" .vil)

                # Skip corne_nwwy.vil (historical reference file with invalid layer references)
                # Images are maintained in images/nwwy/ directory
                if [ "$base_name" = "corne_nwwy" ]; then
                  echo "  ‚è≠Ô∏è  Skipping: $vil_file (historical reference file)"
                  continue
                fi

                json_file="firmware/${base_name}.json"
                yaml_file="firmware/${base_name}.yaml"

                # Convert .vil to JSON (filter out completely empty layers)
                echo "  üìÑ Converting: $vil_file"
                if vil2json "$vil_file" -o "$json_file" -f; then
                  # Parse JSON to YAML with config to apply raw_binding_map (keycode ‚Üí symbol transformation)
                  echo "  üìù Generating: $yaml_file"
                  if keymap -c keymap-drawer.yaml parse -q "$json_file" -o "$yaml_file"; then
                    echo "  ‚úÖ Success: $base_name"
                    success_count=$((success_count + 1))
                  else
                    echo "  ‚ùå ERROR: Failed to parse $json_file to YAML"
                    failure_count=$((failure_count + 1))
                    failed_files="$failed_files\n  - $base_name (YAML parse failed)"
                  fi
                else
                  echo "  ‚ùå ERROR: Failed to convert $vil_file to JSON"
                  failure_count=$((failure_count + 1))
                  failed_files="$failed_files\n  - $base_name (JSON conversion failed)"
                fi
              fi
            done

            echo ""
            echo "=== Conversion Summary ==="
            echo "‚úÖ Successful: $success_count"
            echo "‚ùå Failed: $failure_count"

            if [ $failure_count -gt 0 ]; then
              echo ""
              echo "Failed files:"
              echo -e "$failed_files"
              echo ""
              echo "ERROR: Some conversions failed. Halting workflow."
              exit 1
            fi

            echo '‚úÖ All conversions completed successfully'
          SCRIPT
      - name: Generate layout images from YAML files
        run: |
          echo "=== Generating Layout Images from YAML ==="

          # Create output directory
          mkdir -p images/generated/

          # Enter nix development environment and generate images
          nix develop --command bash <<'SCRIPT'
            set -e  # Exit immediately if a command fails
            echo 'üé® Generating images from YAML files...'

            # Track generation status
            success_count=0
            failure_count=0
            failed_files=""

            for yaml_file in firmware/*.yaml; do
              if [ -f "$yaml_file" ]; then
                base_name=$(basename "$yaml_file" .yaml)

                # Skip corne_nwwy.yaml (historical reference, images in images/nwwy/)
                if [ "$base_name" = "corne_nwwy" ]; then
                  echo "‚è≠Ô∏è  Skipping: $yaml_file (historical reference file)"
                  continue
                fi

                output_svg="images/generated/${base_name}.svg"
                output_pdf="images/generated/${base_name}.pdf"
                output_png="images/generated/${base_name}.png"

                echo "üì∏ Generating: $output_svg"
                # Automatically draw all non-empty layers (filtered by vil2json -f)
                # Use custom config to display actual symbols instead of keycodes
                # NOTE: -c must come BEFORE the draw subcommand
                if keymap -c keymap-drawer.yaml draw "$yaml_file" -o "$output_svg"; then
                  # Validate SVG file size (detect 0-byte files)
                  svg_size=$(stat -c%s "$output_svg" 2>/dev/null || stat -f%z "$output_svg" 2>/dev/null)
                  if [ "$svg_size" -eq 0 ]; then
                    echo "  ‚ùå ERROR: Generated SVG is empty (0 bytes)"
                    ((failure_count++))
                    failed_files="$failed_files\n  - $base_name (0-byte SVG)"
                    continue
                  fi

                  echo "  ‚úÖ SVG generated successfully (${svg_size} bytes)"

                  # Convert SVG to PDF for printing
                  if command -v rsvg-convert >/dev/null 2>&1; then
                    echo "  üìÑ Converting to PDF: $output_pdf"
                    if rsvg-convert -f pdf -o "$output_pdf" "$output_svg"; then
                      pdf_size=$(stat -c%s "$output_pdf" 2>/dev/null || stat -f%z "$output_pdf" 2>/dev/null)
                      echo "  ‚úÖ PDF generated successfully (${pdf_size} bytes)"
                    else
                      echo "  ‚ö†Ô∏è Warning: PDF conversion failed, continuing..."
                    fi
                  else
                    echo "  ‚ÑπÔ∏è rsvg-convert not available, skipping PDF conversion"
                  fi

                  # Convert SVG to PNG using ImageMagick (if available)
                  if command -v convert >/dev/null 2>&1; then
                    echo "  üñºÔ∏è Converting to PNG: $output_png"
                    if convert "$output_svg" "$output_png"; then
                      png_size=$(stat -c%s "$output_png" 2>/dev/null || stat -f%z "$output_png" 2>/dev/null)
                      echo "  ‚úÖ PNG generated successfully (${png_size} bytes)"
                    else
                      echo "  ‚ö†Ô∏è Warning: PNG conversion failed, continuing..."
                    fi
                  else
                    echo "  ‚ÑπÔ∏è ImageMagick not available, skipping PNG conversion"
                  fi

                  success_count=$((success_count + 1))
                else
                  echo "  ‚ùå ERROR: Failed to generate image for $yaml_file"
                  failure_count=$((failure_count + 1))
                  failed_files="$failed_files\n  - $base_name (keymap draw failed)"
                fi
              fi
            done

            echo ""
            echo "=== Image Generation Summary ==="
            echo "‚úÖ Successful: $success_count"
            echo "‚ùå Failed: $failure_count"
            echo ""
            echo "Generated files:"
            ls -lh images/generated/ || echo 'No images generated'

            if [ $failure_count -gt 0 ]; then
              echo ""
              echo "Failed files:"
              echo -e "$failed_files"
              echo ""
              echo "ERROR: Some image generations failed. Halting workflow."
              exit 1
            fi

            echo ""
            echo '‚úÖ All images generated successfully'
          SCRIPT
      - name: Commit generated images
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Add generated files
          git add images/generated/

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to commit"
          else
            echo "üìù Committing generated layout images"
            # Bypass pre-commit hooks for automated commits (generated files already validated)
            git -c core.hooksPath=/dev/null commit -m "$(cat <<'EOF'
          üé® Auto-update layout images from VIAL files

          ü§ñ Auto-converted via vil2json + keymap-drawer in GitHub Actions
          üìÑ Generated formats: SVG (web), PDF (printing), PNG (preview)
          EOF
          )"
            git push
          fi
      - name: Upload generated images as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: generated-layout-images
          path: images/generated/
          retention-days: 30
      - name: Comment on PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            let comment = `## üé® Layout Images Generated

            **Status:** ‚úÖ Successfully generated layout images
            **Commit:** ${context.sha.substring(0, 7)}
            **Formats:** SVG (web), PDF (printing), PNG (preview)

            ### Generated Images:`;

            // List generated images
            const generatedDir = 'images/generated';
            if (fs.existsSync(generatedDir)) {
              const files = fs.readdirSync(generatedDir);
              const svgFiles = files.filter(f => f.endsWith('.svg'));

              if (svgFiles.length > 0) {
                svgFiles.forEach(file => {
                  const baseName = path.basename(file, '.svg');
                  comment += `\n- üñºÔ∏è ${baseName}`;
                });
              } else {
                comment += `\n- ‚ÑπÔ∏è No images generated`;
              }
            } else {
              comment += `\n- ‚ö†Ô∏è Generated images directory not found`;
            }

            comment += `

            ### Workflow:
            1. **VIAL files (.vil)** ‚Üí **Auto-conversion** ‚Üí **JSON** ‚Üí **YAML** ‚Üí **SVG/PDF/PNG images**
            2. Layer filtering applied (L0-L5 only, 60% size reduction)
            3. Symbol translation (shows \`[\` instead of \`LBRACKET\`)
            4. PDF generation for printing layouts
            5. Images are automatically committed when this PR is merged

            ---
            *Note: Fully automated via custom \`vil2json\` Rust tool + keymap-drawer + librsvg*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
